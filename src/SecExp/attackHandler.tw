:: attackHandler

/*Init*/
<<set _phase = 0>>
<<set _attack = 0>>
<<set _defense = 0>>
<<set _morale = 0>>
<<set _hp = 0>>
<<set _enemyAttack = 0>>
<<set _enemyDefense = 0>>
<<set _enemyMorale = 0>>
<<set _enemyHp = 0>>
<<set _mL = $militiaUnits.length>>
<<set _sL = $slaveUnits.length>>
<<set _meL = $mercUnits.length>>

/* calculates leaders, tactics and terrain modifiers */
<<set _atkMod = 1>>
<<set _defMod = 1>>
<<set _militiaMod = 1>>
<<set _slaveMod = 1>>
<<set _mercMod = 1>>
<<set _enemyMod = 1>>
/*player*/
<<if $leadingTroops == "PC">>
	<<if $authority <= 2500 && $authority > 1000>>
		<<set _slaveMod -= 0.10>>
	<<elseif $authority <= 1000>>
		<<set _slaveMod -= 0.25>>
	<<elseif $authority >= 5000 && $authority < 15000>>
		<<set _slaveMod += 0.10>>
	<<elseif $authority >= 15000>>
		<<set _slaveMod += 0.25>>
	<</if>>
	<<if $PC.career == "escort" || $PC.career == "servant">>
		<<set _slaveMod += 0.10>>
	<<elseif $PC.career == "slaver">>
		<<set _slaveMod -= 0.10>>
	<</if>>
	<<if $rep <= 2500 && $rep > 1000>>
		<<set _militiaMod -= 0.10>>
	<<elseif $rep <= 1000>>
		<<set _militiaMod -= 0.25>>
	<<elseif $rep >= 5000 && $rep < 15000>>
		<<set _militiaMod += 0.10>>
	<<elseif $rep >= 15000>>
		<<set _militiaMod += 0.25>>
	<</if>>
	<<if $PC.career == "celebrity" || $PC.career == "capitalist">>
		<<set _militiaMod += 0.10>>
	<<elseif $PC.career == "gang" || $PC.career == "escort">>
		<<set _militiaMod -= 0.10>>
	<</if>>
	<<if $mercLoyalty <= 25>>
		<<set _mercMod -= 0.10>>
	<<elseif $mercLoyalty <= 10>>
		<<set _mercMod -= 0.25>>
	<<if $mercLoyalty >= 50 && $mercLoyalty < 75>>
		<<set _mercMod += 0.10>>
	<<elseif $mercLoyalty >= 75>>
		<<set _mercMod += 0.25>>
	<</if>>
	<<if $PC.career == "mercenary">>
		<<set _mercMod += 0.10>>
	<<elseif $PC.career == "wealth" || $PC.career == "servant">>
		<<set _mercMod -= 0.10>>
	<</if>>
	<<if $rep >= 15000>>
		<<set _enemyMod -= 0.10>>
	<</if>>
	<<if $PC.warfare <= 25 && $PC.warfare > 10>>
		<<set _atkMod -= 0.15>>
	<<elseif $PC.warfare <= 10>>
		<<set _atkMod -= 0.20>>
		<<set _defMod -= 0.10>>
	<<elseif $PC.warfare >= 50 && $PC.warfare >= 50>>
		<<set _atkMod += 0.15>>
	<<elseif $PC.warfare >= 75>>
		<<set _atkMod += 0.20>>
		<<set _defMod += 0.10>>
	<</if>>
<<elseif $leadingTroops == "assistant">>
	<<if $rep < 15000 && $authority < 15000>>
		<<set _militiaMod -= 0.15>>
		<<set _slaveMod -= 0.15>>
		<<set _mercMod -= 0.15>>
	<</if>>
	<<if $assistantPower == 0>>
		<<set _atkMod -= 0.10>>
		<<set _defMod -= 0.10>>
	<<elseif $assistantPower == 2>>
		<<set _atkMod += 0.15>>
		<<set _defMod += 0.15>>
	<</if>>
<<elseif $leadingTroops == "bodyguard">>
	<<if $Bodyguard.devotion < -20>>
		<<set _slaveMod -= 0.15>>
	<<elseif $Bodyguard.devotion > 51>>
		<<set _slaveMod += 0.15>>
	<</if>>
	<<if $rep < 15000 && $authority < 15000 || $Bodyguard.prestige < 1>>
		<<set _militiaMod -= 0.15>>
		<<set _mercMod -= 0.15>>
	<<elseif $Bodyguard.prestige >= 2>>
		<<set _militiaMod += 0.10>>
		<<set _mercMod += 0.10>>
	<</if>>
	<<if !(setup.bodyguardCareers.includes($Bodyguard.career) && setup.HGCareers.includes($Bodyguard.career)) || $Bodyguard.intelligence <= -2>>
		<<set _atkMod -= 0.15>>
		<<set _defMod -= 0.15>>
	<<if !(setup.bodyguardCareers.includes($Bodyguard.career) && setup.HGCareers.includes($Bodyguard.career)) || $Bodyguard.intelligence <= -1>>
		<<set _atkMod -= 0.10>>
		<<set _defMod -= 0.10>>
	<<elseif setup.bodyguardCareers.includes($Bodyguard.career) || setup.HGCareers.includes($Bodyguard.career) || $Bodyguard.intelligence == 2>>
		<<set _atkMod += 0.10>>
		<<set _defMod += 0.10>>
	<<elseif (setup.bodyguardCareers.includes($Bodyguard.career) || setup.HGCareers.includes($Bodyguard.career)) && $Bodyguard.intelligence == 2>>
		<<set _atkMod += 0.15>>
		<<set _defMod += 0.10>>
	<<elseif (setup.bodyguardCareers.includes($Bodyguard.career) || setup.HGCareers.includes($Bodyguard.career)) && $Bodyguard.intelligence == 3>>
		<<set _atkMod += 0.20>>
		<<set _defMod += 0.15>>
	<</if>>
<<elseif $leadingTroops == "headGirl">>
	<<if $HeadGirl.devotion < -20>>
		<<set _slaveMod -= 0.15>>
	<<elseif $HeadGirl.devotion > 51>>
		<<set _slaveMod += 0.15>>
	<</if>>
	<<if ($rep < 15000 && $authority < 15000) || $HeadGirl.prestige < 1>>
		<<set _militiaMod -= 0.15>>
		<<set _mercMod -= 0.15>>
	<<elseif $HeadGirl.prestige >= 2>>
		<<set _militiaMod += 0.10>>
		<<set _mercMod += 0.10>>
	<</if>>
	<<if !(setup.bodyguardCareers.includes($HeadGirl.career) && setup.HGCareers.includes($HeadGirl.career)) || $HeadGirl.intelligence <= -2>>
		<<set _atkMod -= 0.15>>
		<<set _defMod -= 0.15>>
	<<if !(setup.bodyguardCareers.includes($HeadGirl.career) && setup.HGCareers.includes($HeadGirl.career)) || $HeadGirl.intelligence <= -1>>
		<<set _atkMod -= 0.10>>
		<<set _defMod -= 0.10>>
	<<elseif setup.bodyguardCareers.includes($HeadGirl.career) || setup.HGCareers.includes($HeadGirl.career) || $HeadGirl.intelligence == 2>>
		<<set _atkMod += 0.10>>
		<<set _defMod += 0.10>>
	<<elseif (setup.bodyguardCareers.includes($HeadGirl.career) || setup.HGCareers.includes($HeadGirl.career)) && $HeadGirl.intelligence == 2>>
		<<set _atkMod += 0.15>>
		<<set _defMod += 0.10>>
	<<elseif (setup.bodyguardCareers.includes($HeadGirl.career) || setup.HGCareers.includes($HeadGirl.career)) && $HeadGirl.intelligence == 3>>
		<<set _atkMod += 0.20>>
		<<set _defMod += 0.15>>
	<</if>>
<<elseif $leadingTroops == "citizen">>
	<<if $arcologies[0].FSDegradationist == "unset" && $arcologies[0].FSPaternalist == "unset">>
		<<set _militiaMod += 0.15>>
		<<set _slaveMod -= 0.15>>
	<<elseif $arcologies[0].FSPaternalist != "unset">>
		<<set _militiaMod += 0.15>>
		<<set _slaveMod += 0.10>>
	<<elseif $arcologies[0].FSDegradationist != "unset">>
		<<set _militiaMod += 0.15>>
		<<set _slaveMod -= 0.35>>
	<</if>>
	<<if $arcologies[0].FSRomanRevivalist != "unset">>
		<<set _mercMod += 0.10>>
	<<else>>
		<<set _mercMod -= 0.10>>
	<</if>>
	<<set _atkMod += either(-1,1) * random(10) * 0.1>>
	<<set _defMod += either(-1,1) * random(10) * 0.1>>
<<elseif $leadingTroops == "mercenary">>

<</if>>

/* calculates PC army stats */
<<if $secBots.isDeployed == 1>>
	<<set _attack += $secBotsBaseAttack + $secBotsBaseAttack * $secBots.equip * $equipMod>>
	<<set _defense += $secBotsBaseDefense + $secBotsBaseDefense * $secBots.equip * $equipMod>>
	<<set _morale += $secBotsMorale>>
	<<set _hp += $secBotsBaseHp * $secBots.troops>>
<</if>>
<<for _i = 0; _i < _mL; _i++>>
	<<if $militiaUnits[_i].isDeployed == 1>>
		<<set _attack += $militiaBaseAttack + $militiaBaseAttack * $militiaUnits[_i].equip * $equipMod>>
		<<set _defense += $militiaBaseDefense + $militiaBaseDefense * $militiaUnits[_i].equip * $equipMod>>
		<<set _morale += $militiaBaseMorale + $militiaBaseMorale * $militiaUnits[_i].escorts * $equipMod>>
		<<set _hp += ($militiaBaseHp + $militiaBaseHp * $militiaUnits[_i].medics * $equipMod) * $militiaUnits[_i].troops >>
	<</if>>
<</for>>
<<for _i = 0; _i < _sL; _i++>>
	<<if $slaveUnits[_i].isDeployed == 1>>
		<<set _attack += $slaveBaseAttack + $slaveBaseAttack * $slaveUnits[_i].equip * $equipMod>>
		<<set _defense += $slaveBaseDefense + $slaveBaseDefense * $slaveUnits[_i].equip * $equipMod>>
		<<set _morale += $slaveBaseMorale + $slaveBaseMorale * $slaveUnits[_i].escorts * $equipMod>>
		<<set _hp += ($slaveBaseHp + $slaveBaseHp * $slaveUnits[_i].medics * 0.25) * $slaveUnits[_i].troops>>
	<</if>>
<</for>>
<<for _i = 0; _i < _meL; _i++>>
	<<if $mercUnits[_i].isDeployed == 1>>
		<<set _attack += $mercBaseAttack + $mercBaseAttack * $mercUnits[_i].equip * $equipMod>>
		<<set _defense += $mercBaseDefense + $mercBaseDefense * $mercUnits[_i].equip * $equipMod>>
		<<set _morale += $mercBaseMorale + $mercBaseMorale * $mercUnits[_i].escorts * $equipMod>>
		<<set _hp += ($mercBaseHp + $mercBaseHp * $mercUnits[_i].medics * 0.25) * $mercUnits[_i].troops>>
	<</if>>
<</for>>

/* calculates enemy army stats */
<<if $attackType == "raiders">>
	<<set _enemyAttack = $raBaseAttack * $raBaseAttack * $attackEquip * $equipMod>>
	<<set _enemyDefense = $raBaseDefense + $raBaseDefense * $attackEquip * $equipMod>>
	<<set _enemyMorale = $raBaseMorale>>
	<<set _enemyHp = $raBaseHp * $attackTroops>>
<<elseif $attackType == "free city">>
	<<set _enemyAttack = $fcBaseAttack * $fcBaseAttack * $attackEquip * $equipMod>>
	<<set _enemyDefense = $fcBaseDefense + $fcBaseDefense * $attackEquip * $equipMod>>
	<<set _enemyMorale = $fcBaseMorale>>
	<<set _enemyHp = $fcBaseHp * $attackTroops>>
<<elseif $attackType == "old world">>
	<<set _enemyAttack = $owBaseAttack + $owBaseAttack * $attackEquip * $equipMod>>
	<<set _enemyDefense = $owBaseDefense + $owBaseDefense * $attackEquip * $equipMod>>
	<<set _enemyMorale = $owBaseMorale>>
	<<set _enemyHp = $owBaseHp * $attackTroops>>
<<elseif $attackType == "freedom fighters">>
	<<set _enemyAttack = $ffBaseAttack + $ffBaseAttack * $attackEquip * $equipMod>>
	<<set _enemyDefense = $ffBaseDefense + $ffBaseDefense * $attackEquip * $equipMod>>
	<<set _enemyMorale = $ffBaseMorale>>
	<<set _enemyHp = $ffBaseHp * $attackTroops>>
<</if>>


/* simulates the combat by pitting attk against def */
<<for _i = 0; _i < $maxTurns; _i++>>


<</for>>






/* resets variables */
<<set $attackType = "none">>
<<set $chosenTactic = "none">>
<<set $leadingTroops = "none">>
<<set $attackTroops = 0>>
<<set $attackEquip = 0>>
<<set $deployableUnits = 0>>
<<set $deployedUnits = 0>>
<<set $deployingBots = 0>>
<<set $deployingMilitia = 0>>
<<set $deployingSlaves = 0>>
<<set $deployingMercs = 0>>
<<set $battleTerrain = "none">>
<<set $attackThisWeek = 0>>
<<set $deployableUnits = 0>>
<<set $deployedUnits = 0>>
<<set $secBots.isDeployed = 0>>
<<for _i = 0; _i < _mL; _i++>>
	<<set $militiaUnits[_i].isDeployed = 0>>
<</for>>	
<<for _i = 0; _i < _sL; _i++>>
	<<set $slaveUnits[_i].isDeployed = 0>>
<</for>>	
<<for _i = 0; _i < _meL; _i++>>
	<<set $mercUnits[_i].isDeployed = 0>>
<</for>>	