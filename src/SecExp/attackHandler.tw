:: attackHandler [nobr]

<<set $nextButton = "", $nextLink = "attackOptions", $showEncyclopedia = 0>>

<<if $battleResult != 1 && $battleResult != -1>>		/* if the player did not select bribe or surrender */
/*Init*/
<<set _turn = 0>>
<<set _attack = 0>>
<<set _defense = 0>>
<<set _morale = 0>>
<<set _hp = 0>>
<<set _baseHp = 0>>
<<set _enemyAttack = 0>>
<<set _enemyDefense = 0>>
<<set _enemyMorale = 0>>
<<set _enemyHp = 0>>
<<set _enemyBaseHp = 0>>
<<set _woundChance = 5>>								/* leader has a base chance of 5% to get wounded */
<<set _tacChance = 0.5>> 								/* by default tactics have a 50% chance of succeeding */
<<set _atkMod = 1>>
<<set _defMod = 1>>
<<set _militiaMod = 1>>
<<set _slaveMod = 1>>
<<set _mercMod = 1>>
<<set _enemyMod = 1>>
<<set _expBonus = 0>>

/* Leaders */
<<if $leadingTroops == "PC">>
	<<if $authority <= 2500 && $authority > 1000>>
		<<set _slaveMod -= 0.10>>
	<<elseif $authority <= 1000>>
		<<set _slaveMod -= 0.25>>
	<<elseif $authority >= 5000 && $authority < 15000>>
		<<set _slaveMod += 0.10>>
	<<elseif $authority >= 15000>>
		<<set _slaveMod += 0.25>>
	<</if>>
	<<if $PC.career == "escort" || $PC.career == "servant">>
		<<set _slaveMod += 0.10>>
	<<elseif $PC.career == "slaver">>
		<<set _slaveMod -= 0.10>>
	<</if>>
	<<if $rep <= 2500 && $rep > 1000>>
		<<set _militiaMod -= 0.10>>
	<<elseif $rep <= 1000>>
		<<set _militiaMod -= 0.25>>
	<<elseif $rep >= 5000 && $rep < 15000>>
		<<set _militiaMod += 0.10>>
	<<elseif $rep >= 15000>>
		<<set _militiaMod += 0.25>>
	<</if>>
	<<if $PC.career == "celebrity" || $PC.career == "capitalist">>
		<<set _militiaMod += 0.10>>
	<<elseif $PC.career == "gang" || $PC.career == "escort">>
		<<set _militiaMod -= 0.10>>
	<</if>>
	<<if $mercLoyalty <= 25>>
		<<set _mercMod -= 0.10>>
	<<elseif $mercLoyalty <= 10>>
		<<set _mercMod -= 0.25>>
	<<elseif $mercLoyalty >= 50 && $mercLoyalty < 75>>
		<<set _mercMod += 0.10>>
	<<elseif $mercLoyalty >= 75>>
		<<set _mercMod += 0.25>>
	<</if>>
	<<if $PC.career == "mercenary">>
		<<set _mercMod += 0.10>>
	<<elseif $PC.career == "wealth" || $PC.career == "servant">>
		<<set _mercMod -= 0.10>>
	<</if>>
	<<if $rep >= 15000>>
		<<set _enemyMod -= 0.10>>
	<</if>>
	<<if $PC.warfare <= 25 && $PC.warfare > 10>>
		<<set _atkMod -= 0.15>>
		<<set _tacChance -= 0.15>>
	<<elseif $PC.warfare <= 10>>
		<<set _atkMod -= 0.20>>
		<<set _defMod -= 0.10>>
		<<set _tacChance -= 0.30>>
	<<elseif $PC.warfare >= 50 && $PC.warfare >= 50>>
		<<set _atkMod += 0.15>>
		<<set _tacChance += 0.15>>
	<<elseif $PC.warfare >= 75>>
		<<set _atkMod += 0.20>>
		<<set _defMod += 0.10>>
		<<set _tacChance += 0.30>>
	<</if>>
	/* 80% chance of increasing warfare */
	<<if $PC.warfare < 100 && random(1,100) <= 80>>
		<<set $gainedWarfare = 1>>
		<<set $PC.warfare += 10>>
		<<set $PC.warfare = Math.clamp($PC.warfare,-100,100)>>
	<</if>>
		/* does the PC get wounded? */
	<<if $PC.career == "mercenary" || $PC.career == "gang">>
		<<set _woundChance -= 3>>
	<</if>>
	<<if $PC.physicalAge >= 60>>
		<<set _woundChance += 1>>
	<</if>>
	<<if $PC.belly > 5000>>
		<<set _woundChance += 1>>
	<</if>>
	<<if $PC.boobsBonus >= 2>>
		<<set _woundChance += 1>>
	<</if>>
	<<if $PC.butt >= 2>>
		<<set _woundChance += 1>>
	<</if>>
	<<if $PC.preg >= 30>>
		<<set _woundChance += 1>>
	<</if>>
	<<if $PC.balls == 2>>
		<<set _woundChance += 1>>
	<</if>>
	<<if $PC.ballsImplant >= 2>>
		<<set _woundChance += 1>>
	<</if>>	
	<<if random(1,100) <= _woundChance>>
		<<set $leaderWounded = 1>>
		<<set _militiaMod -= 0.2>>
		<<set _slaveMod -= 0.2>>
		<<set _mercMod -= 0.2>>
		<<set _enemyMod += 0.2>>
		<<set $PCWounded = 1>>
	<</if>>
<<elseif $leadingTroops == "assistant">>
	<<if $rep < 10000 && $authority < 10000>>
		<<set _militiaMod -= 0.15>>
		<<set _slaveMod -= 0.15>>
		<<set _mercMod -= 0.15>>
	<</if>>
	<<if $assistantPower == 0>>
		<<set _atkMod -= 0.10>>
		<<set _defMod -= 0.10>>
		<<set _tacChance -= 0.20>>
	<<elseif $assistantPower == 2>>
		<<set _atkMod += 0.15>>
		<<set _defMod += 0.15>>
		<<set _tacChance += 0.30>>
	<</if>>
<<elseif $leadingTroops == "bodyguard">>
	<<if $Bodyguard.devotion < -20>>
		<<set _slaveMod -= 0.15>>
	<<elseif $Bodyguard.devotion >= 50>>
		<<set _slaveMod += 0.15>>
	<</if>>
	<<if ($rep < 10000 && $authority < 10000) || $Bodyguard.prestige < 1>>
		<<set _militiaMod -= 0.15>>
		<<set _mercMod -= 0.15>>
	<<elseif $Bodyguard.prestige >= 2>>
		<<set _militiaMod += 0.10>>
		<<set _mercMod += 0.10>>
	<</if>>
	<<if (setup.bodyguardCareers.includes($Bodyguard.career) || setup.HGCareers.includes($Bodyguard.career)) && $Bodyguard.intelligence == 3>>
		<<set _atkMod += 0.25>>
		<<set _defMod += 0.25>>
		<<set _tacChance += 0.50>>
	<<elseif $Bodyguard.intelligence == 3>>
		<<set _atkMod += 0.20>>
		<<set _defMod += 0.15>>
		<<set _tacChance += 0.35>>
	<<elseif (setup.bodyguardCareers.includes($Bodyguard.career) || setup.HGCareers.includes($Bodyguard.career)) && $Bodyguard.intelligence == 2>>
		<<set _atkMod += 0.15>>
		<<set _defMod += 0.10>>
		<<set _tacChance += 0.25>>
	<<elseif $Bodyguard.intelligence == 2>>
		<<set _atkMod += 0.10>>
		<<set _defMod += 0.10>>
		<<set _tacChance += 0.20>>
	<<elseif setup.bodyguardCareers.includes($Bodyguard.career) || setup.HGCareers.includes($Bodyguard.career) && $Bodyguard.intelligence >= 1>>
		<<set _atkMod += 0.10>>
		<<set _defMod += 0.05>>
		<<set _tacChance += 0.15>>
	<<elseif !(setup.bodyguardCareers.includes($Bodyguard.career) && setup.HGCareers.includes($Bodyguard.career)) || $Bodyguard.intelligence <= -2>>
		<<set _atkMod -= 0.15>>
		<<set _defMod -= 0.15>>
		<<set _tacChance -= 0.30>>
	<<elseif $Bodyguard.intelligence <= -2>>
		<<set _atkMod -= 0.15>>
		<<set _defMod -= 0.10>>
		<<set _tacChance -= 0.25>>
	<<elseif !(setup.bodyguardCareers.includes($Bodyguard.career) && setup.HGCareers.includes($Bodyguard.career)) || $Bodyguard.intelligence <= -1>>
		<<set _atkMod -= 0.10>>
		<<set _defMod -= 0.10>>
		<<set _tacChance -= 0.20>>
	<<elseif $Bodyguard.intelligence <= -1>>
		<<set _atkMod -= 0.10>>
		<<set _defMod -= 0.05>>
		<<set _tacChance -= 0.15>>
	<</if>>
		/* does she get wounded? */
	<<if $Bodyguard.combatSkill == 1>>
		<<set _woundChance -= 3>>
	<</if>>
	<<if $Bodyguard.health >= 50>>
		<<set _woundChance -= 2>>
	<</if>>
	<<if $Bodyguard.weight > 130>>
		<<set _woundChance += 1>>
	<</if>>
	<<if $Bodyguard.muscles < -30>>
		<<set _woundChance += 1>>
	<</if>>
	<<if $Bodyguard.eyes <= -2>>
		<<set _woundChance += 1>>
	<</if>>
	<<if $Bodyguard.heels == 1>>
		<<set _woundChance += 1>>
	<</if>>
	<<if $Bodyguard.boobs >= 1400>>
		<<set _woundChance += 1>>
	<</if>>
	<<if $Bodyguard.butt >= 6>>
		<<set _woundChance += 1>>
	<</if>>
	<<if $Bodyguard.preg >= 30>>
		<<set _woundChance += 1>>
	<</if>>
	<<if $Bodyguard.dick >= 8>>
		<<set _woundChance += 1>>
	<</if>>
	<<if $Bodyguard.balls >= 8>>
		<<set _woundChance += 1>>
	<</if>>
	<<if $Bodyguard.intelligence <= -3>>
		<<set _woundChance += 1>>
	<</if>>	
	<<if random(1,100) <= _woundChance>>
		<<set $leaderWounded = 1>>
		<<set _militiaMod -= 0.2>>
		<<set _slaveMod -= 0.2>>
		<<set _mercMod -= 0.2>>
		<<set _enemyMod += 0.2>>
		<<set $woundType = random(1,10)>>
		<<if $woundType == 1>>
			<<set $Bodyguard.voice = 0>>
		<<elseif $woundType == 2>>
			<<set $Bodyguard.eyes = -2>>
		<<elseif $woundType == 3>>
			<<set $Bodyguard.amp = 1>>
		<<elseif $woundType >= 4>>
			<<if $Bodyguard.health >= -60>>
				<<set $Bodyguard.health -= 30>>
			<<else>>
				<<set $Bodyguard.health -= Math.abs(90 - $Bodyguard.health)>>
			<</if>>
		<</if>>
	<</if>>
	/* 60% chance of getting combat skill if not already have it */
	<<if $Bodyguard.combatSkill == 0 && random(1,100) <= 60>>
		<<set $gainedCombat = 1>>
		<<set $Bodyguard.combatSkill = 1>>
	<</if>>
<<elseif $leadingTroops == "headGirl">>
	<<if $HeadGirl.devotion < -20>>
		<<set _slaveMod -= 0.15>>
	<<elseif $HeadGirl.devotion > 51>>
		<<set _slaveMod += 0.15>>
	<</if>>
	<<if ($rep < 10000 && $authority < 10000) || $HeadGirl.prestige < 1>>
		<<set _militiaMod -= 0.15>>
		<<set _mercMod -= 0.15>>
	<<elseif $HeadGirl.prestige >= 2>>
		<<set _militiaMod += 0.10>>
		<<set _mercMod += 0.10>>
	<</if>>
	<<if (setup.bodyguardCareers.includes($HeadGirl.career) || setup.HGCareers.includes($HeadGirl.career)) && $HeadGirl.intelligence == 3>>
		<<set _atkMod += 0.25>>
		<<set _defMod += 0.25>>
		<<set _tacChance += 0.50>>
	<<elseif $HeadGirl.intelligence == 3>>
		<<set _atkMod += 0.20>>
		<<set _defMod += 0.15>>
		<<set _tacChance += 0.35>>
	<<elseif (setup.bodyguardCareers.includes($HeadGirl.career) || setup.HGCareers.includes($HeadGirl.career)) && $HeadGirl.intelligence == 2>>
		<<set _atkMod += 0.15>>
		<<set _defMod += 0.10>>
		<<set _tacChance += 0.25>>
	<<elseif $HeadGirl.intelligence == 2>>
		<<set _atkMod += 0.10>>
		<<set _defMod += 0.10>>
		<<set _tacChance += 0.20>>
	<<elseif setup.bodyguardCareers.includes($HeadGirl.career) || setup.HGCareers.includes($HeadGirl.career) && $HeadGirl.intelligence >= 1>>
		<<set _atkMod += 0.10>>
		<<set _defMod += 0.05>>
		<<set _tacChance += 0.15>>
	<<elseif !(setup.bodyguardCareers.includes($HeadGirl.career) && setup.HGCareers.includes($HeadGirl.career)) || $HeadGirl.intelligence <= -2>>
		<<set _atkMod -= 0.15>>
		<<set _defMod -= 0.15>>
		<<set _tacChance -= 0.30>>
	<<elseif $HeadGirl.intelligence <= -2>>
		<<set _atkMod -= 0.15>>
		<<set _defMod -= 0.10>>
		<<set _tacChance -= 0.25>>
	<<elseif !(setup.bodyguardCareers.includes($HeadGirl.career) && setup.HGCareers.includes($HeadGirl.career)) || $HeadGirl.intelligence <= -1>>
		<<set _atkMod -= 0.10>>
		<<set _defMod -= 0.10>>
		<<set _tacChance -= 0.20>>
	<<elseif $HeadGirl.intelligence <= -1>>
		<<set _atkMod -= 0.10>>
		<<set _defMod -= 0.05>>
		<<set _tacChance -= 0.15>>
	<</if>>
	/* does she get wounded? */
	<<if $HeadGirl.combatSkill == 1>>
		<<set _woundChance -= 3>>
	<</if>>
	<<if $HeadGirl.health >= 50>>
		<<set _woundChance -= 2>>
	<</if>>
	<<if $HeadGirl.weight > 130>>
		<<set _woundChance += 1>>
	<</if>>
	<<if $HeadGirl.muscles < -30>>
		<<set _woundChance += 1>>
	<</if>>
	<<if $HeadGirl.eyes <= -2>>
		<<set _woundChance += 1>>
	<</if>>
	<<if $HeadGirl.heels == 1>>
		<<set _woundChance += 1>>
	<</if>>
	<<if $HeadGirl.boobs >= 1400>>
		<<set _woundChance += 1>>
	<</if>>
	<<if $HeadGirl.butt >= 6>>
		<<set _woundChance += 1>>
	<</if>>
	<<if $HeadGirl.preg >= 30>>
		<<set _woundChance += 1>>
	<</if>>
	<<if $HeadGirl.dick >= 8>>
		<<set _woundChance += 1>>
	<</if>>
	<<if $HeadGirl.balls >= 8>>
		<<set _woundChance += 1>>
	<</if>>
	<<if $HeadGirl.intelligence <= -3>>
		<<set _woundChance += 1>>
	<</if>>	
	<<if random(1,100) <= _woundChance>>
		<<set $leaderWounded = 1>>
		<<set _militiaMod -= 0.2>>
		<<set _slaveMod -= 0.2>>
		<<set _mercMod -= 0.2>>
		<<set _enemyMod += 0.2>>
		<<set $woundType = random(1,10)>>
		<<if $woundType == 1>>
			<<set $HeadGirl.voice = 0>>
		<<elseif $woundType == 2>>
			<<set $HeadGirl.eyes = -2>>
		<<elseif $woundType == 3>>
			<<set $HeadGirl.amp = 1>>
		<<elseif $woundType >= 4>>
			<<set $HeadGirl.health -= 40>>
		<</if>>
	<</if>>
	/* 60% chance of getting combat skill if nto already have it */
	<<if $HeadGirl.combatSkill == 0 && random(1,100) <= 60>>
		<<set $gainedCombat = 1>>
		<<set $HeadGirl.combatSkill = 1>>
	<</if>>
<<elseif $leadingTroops == "citizen">>
	<<if $arcologies[0].FSDegradationist == "unset" && $arcologies[0].FSPaternalist == "unset">>
		<<set _militiaMod += 0.15>>
		<<set _slaveMod -= 0.15>>
	<<elseif $arcologies[0].FSPaternalist != "unset">>
		<<set _militiaMod += 0.15>>
		<<set _slaveMod += 0.10>>
	<<elseif $arcologies[0].FSDegradationist != "unset">>
		<<set _militiaMod += 0.15>>
		<<set _slaveMod -= 0.35>>
	<</if>>
	<<if $arcologies[0].FSRomanRevivalist != "unset">>
		<<set _mercMod += 0.10>>
	<<else>>
		<<set _mercMod -= 0.10>>
	<</if>>
	<<set _atkMod += either(-1,1) * random(10) * 0.1>>
	<<set _defMod += either(-1,1) * random(10) * 0.1>>
	<<set _tacChance += either(-1,1) * random(20) * 0.1>>
<<elseif $leadingTroops == "mercenary">>
	<<set _mercMod += 0.10>>
	<<if $arcologies[0].FSRomanRevivalist != "unset">>
		<<set _militiaMod += 0.10>>
	<<else>>
		<<set _militiaMod -= 0.10>>
	<</if>>
	<<if $arcologies[0].FSDegradationist != "unset">>
		<<set _slaveMod -= 0.35>>
	<</if>>
	<<set _atkMod += random(15) * 0.1>>
	<<set _defMod += random(15) * 0.1>>
	<<set _tacChance += random(30) * 0.1>>
<</if>>
/* Terrain and Tactics */
<<if $battleTerrain == "urban">>
	<<if $chosenTactic == "Bait and Bleed">>
		<<set _atkMod += 0.15>>
		<<set _defMod += 0.10>>
		<<set _tacChance += 0.25>>
	<<elseif $chosenTactic == "Guerrilla">>
		<<set _atkMod += 0.10>>
		<<set _defMod += 0.15>>
		<<set _tacChance += 0.25>>
	<<elseif $chosenTactic == "Choke Points">>
		<<set _atkMod += 0.10>>
		<<set _defMod += 0.15>>
		<<set _tacChance += 0.25>>
	<<elseif $chosenTactic == "Interior Lines">>
		<<set _atkMod += 0.05>>
		<<set _defMod += 0.10>>
		<<set _tacChance += 0.15>>
	<<elseif $chosenTactic == "Pincer Manouver">>
		<<set _atkMod -= 0.05>>
		<<set _defMod -= 0.10>>
		<<set _tacChance -= 0.15>>
	<<elseif $chosenTactic == "Defense In Depth">>
		<<set _atkMod -= 0.05>>
		<<set _defMod -= 0.05>>
		<<set _tacChance -= 0.10>>
	<<elseif $chosenTactic == "Blitzkrieg">>
		<<set _atkMod -= 0.15>>
		<<set _defMod -= 0.10>>
		<<set _tacChance -= 0.25>>
	<<elseif $chosenTactic == "Human Wave">>
		<<set _atkMod -= 0.15>>
		<<set _defMod -= 0.15>>
		<<set _tacChance -= 0.30>>
	<</if>>
<<elseif $battleTerrain == "rural">>
	<<if $chosenTactic == "Bait and Bleed">>
		<<set _atkMod -= 0.05>>
		<<set _defMod -= 0.10>>
		<<set _tacChance -= 0.15>>
	<<elseif $chosenTactic == "Guerrilla">>
		<<set _atkMod -= 0.10>>
		<<set _defMod -= 0.10>>
		<<set _tacChance -= 0.20>>
	<<elseif $chosenTactic == "Choke Points">>
		<<set _atkMod -= 0.10>>
		<<set _defMod -= 0.15>>
		<<set _tacChance -= 0.25>>
	<<elseif $chosenTactic == "Interior Lines">>
		<<set _atkMod += 0.10>>
		<<set _defMod += 0.15>>
		<<set _tacChance += 0.25>>
	<<elseif $chosenTactic == "Pincer Manouver">>
		<<set _atkMod += 0.15>>
		<<set _defMod += 0.10>>
		<<set _tacChance += 0.25>>
	<<elseif $chosenTactic == "Defense In Depth">>
		<<set _atkMod += 0.15>>
		<<set _defMod += 0.15>>
		<<set _tacChance += 0.30>>
	<<elseif $chosenTactic == "Blitzkrieg">>
		<<set _atkMod += 0.15>>
		<<set _defMod += 0.10>>
		<<set _tacChance += 0.25>>
	<<elseif $chosenTactic == "Human Wave">>
		<<set _atkMod += 0.20>>
		<<set _defMod += 0.05>>
		<<set _tacChance += 0.25>>
	<</if>>
<<elseif $battleTerrain == "hills">>
	<<if $chosenTactic == "Bait and Bleed">>
		<<set _atkMod += 0.05>>
		<<set _defMod += 0.05>>
		<<set _tacChance += 0.10>>
	<<elseif $chosenTactic == "Guerrilla">>
		<<set _atkMod += 0.05>>
		<<set _defMod += 0.10>>
		<<set _tacChance += 0.15>>
	<<elseif $chosenTactic == "Choke Points">>
		<<set _atkMod += 0.10>>
		<<set _defMod += 0.10>>
		<<set _tacChance += 0.20>>
	<<elseif $chosenTactic == "Interior Lines">>
		<<set _atkMod -= 0.05>>
		<<set _defMod -= 0.05>>
		<<set _tacChance -= 0.10>>
	<<elseif $chosenTactic == "Pincer Manouver">>
		<<set _atkMod += 0.10>>
		<<set _defMod += 0.05>>
		<<set _tacChance += 0.15>>
	<<elseif $chosenTactic == "Defense In Depth">>
		<<set _atkMod -= 0.10>>
		<<set _defMod -= 0.05>>
		<<set _tacChance -= 0.15>>
	<<elseif $chosenTactic == "Blitzkrieg">>
		<<set _atkMod -= 0.10>>
		<<set _defMod -= 0.15>>
		<<set _tacChance += 0.25>>
	<<elseif $chosenTactic == "Human Wave">>
		<<set _atkMod -= 0.15>>
		<<set _defMod -= 0.15>>
		<<set _tacChance -= 0.30>>
	<</if>>
<<elseif $battleTerrain == "coast">>
	<<if $chosenTactic == "Bait and Bleed">>
		<<set _atkMod -= 0.05>>
		<<set _defMod -= 0.05>>
		<<set _tacChance -= 0.10>>
	<<elseif $chosenTactic == "Guerrilla">>
		<<set _atkMod += 0.05>>
		<<set _defMod += 0.05>>
		<<set _tacChance += 0.10>>
	<<elseif $chosenTactic == "Choke Points">>
		<<set _atkMod += 0.05>>
		<<set _defMod += 0.15>>
		<<set _tacChance += 0.15>>
	<<elseif $chosenTactic == "Interior Lines">>
		<<set _atkMod += 0.10>>
		<<set _defMod += 0.10>>
		<<set _tacChance += 0.20>>
	<<elseif $chosenTactic == "Pincer Manouver">>
		<<set _atkMod -= 0.10>>
		<<set _defMod -= 0.10>>
		<<set _tacChance -= 0.20>>
	<<elseif $chosenTactic == "Defense In Depth">>
		<<set _atkMod += 0.10>>
		<<set _defMod += 0.10>>
		<<set _tacChance += 0.20>>
	<<elseif $chosenTactic == "Blitzkrieg">>
		<<set _atkMod -= 0.05>>
		<<set _defMod -= 0.05>>
		<<set _tacChance -= 0.10>>
	<<elseif $chosenTactic == "Human Wave">>
		<<set _atkMod += 0.05>>
		<<set _defMod -= 0.05>>
	<</if>>
<<elseif $battleTerrain == "outskirts">>
	<<if $chosenTactic == "Bait and Bleed">>
		<<set _atkMod -= 0.10>>
		<<set _defMod -= 0.15>>
		<<set _tacChance -= 0.25>>
	<<elseif $chosenTactic == "Guerrilla">>
		<<set _atkMod -= 0.10>>
		<<set _defMod -= 0.05>>
		<<set _tacChance -= 0.15>>
	<<elseif $chosenTactic == "Choke Points">>
		<<set _atkMod += 0.10>>
		<<set _defMod += 0.15>>
		<<set _tacChance += 0.25>>
	<<elseif $chosenTactic == "Interior Lines">>
		<<set _atkMod += 0.15>>
		<<set _defMod += 0.10>>
		<<set _tacChance += 0.25>>
	<<elseif $chosenTactic == "Pincer Manouver">>
		<<set _atkMod += 0.05>>
		<<set _defMod += 0.10>>
		<<set _tacChance += 0.15>>
	<<elseif $chosenTactic == "Defense In Depth">>
		<<set _atkMod += 0.10>>
		<<set _defMod += 0.15>>
		<<set _tacChance += 0.25>>
	<<elseif $chosenTactic == "Blitzkrieg">>
		<<set _atkMod += 0.10>>
		<<set _defMod -= 0.05>>
		<<set _tacChance += 0.05>>
	<<elseif $chosenTactic == "Human Wave">>
		<<set _atkMod += 0.10>>
		<<set _defMod -= 0.10>>
	<</if>>
<<elseif $battleTerrain == "mountains">>
	<<if $chosenTactic == "Bait and Bleed">>
		<<set _atkMod += 0.10>>
		<<set _defMod += 0.15>>
		<<set _tacChance += 0.25>>
	<<elseif $chosenTactic == "Guerrilla">>
		<<set _atkMod += 0.10>>
		<<set _defMod += 0.15>>
		<<set _tacChance += 0.25>>
	<<elseif $chosenTactic == "Choke Points">>
		<<set _atkMod += 0.05>>
		<<set _defMod += 0.20>>
		<<set _tacChance += 0.25>>
	<<elseif $chosenTactic == "Interior Lines">>
		<<set _atkMod += 0.10>>
		<<set _defMod += 0.10>>
		<<set _tacChance += 0.20>>
	<<elseif $chosenTactic == "Pincer Manouver">>
		<<set _atkMod += 0.10>>
		<<set _defMod -= 0.05>>
		<<set _tacChance += 0.05>>
	<<elseif $chosenTactic == "Defense In Depth">>
		<<set _atkMod += 0.10>>
		<<set _defMod += 0.10>>
		<<set _tacChance += 0.20>>
	<<elseif $chosenTactic == "Blitzkrieg">>
		<<set _atkMod -= 0.10>>
		<<set _defMod -= 0.10>>
		<<set _tacChance -= 0.20>>
	<<elseif $chosenTactic == "Human Wave">>
		<<set _atkMod -= 0.10>>
		<<set _defMod -= 0.10>>
		<<set _tacChance -= 0.20>>
	<</if>>
<<elseif $battleTerrain == "wasteland">>
	<<if $chosenTactic == "Bait and Bleed">>
		<<set _atkMod += 0.05>>
		<<set _defMod += 0.05>>
		<<set _tacChance += 0.10>>
	<<elseif $chosenTactic == "Guerrilla">>
		<<set _atkMod += 0.10>>
		<<set _defMod += 0.05>>
		<<set _tacChance += 0.15>>
	<<elseif $chosenTactic == "Choke Points">>
		<<set _atkMod -= 0.10>>
		<<set _defMod += 0.05>>
		<<set _tacChance -= 0.05>>
	<<elseif $chosenTactic == "Interior Lines">>
		<<set _atkMod += 0.10>>
		<<set _defMod += 0.15>>
		<<set _tacChance += 0.25>>
	<<elseif $chosenTactic == "Pincer Manouver">>
		<<set _atkMod += 0.15>>
		<<set _defMod += 0.10>>
		<<set _tacChance += 0.25>>
	<<elseif $chosenTactic == "Defense In Depth">>
		<<set _atkMod += 0.05>>
		<<set _defMod += 0.10>>
		<<set _tacChance += 0.15>>
	<<elseif $chosenTactic == "Blitzkrieg">>
		<<set _atkMod += 0.15>>
		<<set _defMod += 0.15>>
		<<set _tacChance += 0.30>>
	<<elseif $chosenTactic == "Human Wave">>
		<<set _atkMod += 0.20>>
		<<set _defMod += 0.05>>
		<<set _tacChance += 0.25>>
	<</if>>
<</if>>

<<if $chosenTactic == "Bait and Bleed">>
	<<if $attackType == "raiders">>
		<<set _tacChance -= 0.10>>
	<<elseif $attackType == "free city">>
		<<set _tacChance += 0.10>>
	<<elseif $attackType == "old world">>
		<<set _tacChance += 0.25>>
	<<elseif $attackType == "freedom fighters">>
		<<set _tacChance -= 0.15>>
	<</if>>
<<elseif $chosenTactic == "Guerrilla">>
	<<if $attackType == "raiders">>
		<<set _tacChance -= 0.20>>
	<<elseif $attackType == "free city">>
		<<set _tacChance += 0.15>>
	<<elseif $attackType == "old world">>
		<<set _tacChance += 0.25>>
	<<elseif $attackType == "freedom fighters">>
		<<set _tacChance -= 0.25>>
	<</if>>
<<elseif $chosenTactic == "Choke Points">>
	<<if $attackType == "raiders">>
		<<set _tacChance += 0.25>>
	<<elseif $attackType == "free city">>
		<<set _tacChance -= 0.05>>
	<<elseif $attackType == "old world">>
		<<set _tacChance -= 0.10>>
	<<elseif $attackType == "freedom fighters">>
		<<set _tacChance += 0.05>>
	<</if>>
<<elseif $chosenTactic == "Interior Lines">>
	<<if $attackType == "raiders">>
		<<set _tacChance -= 0.15>>
	<<elseif $attackType == "free city">>
		<<set _tacChance += 0.15>>
	<<elseif $attackType == "old world">>
		<<set _tacChance += 0.20>>
	<<elseif $attackType == "freedom fighters">>
		<<set _tacChance -= 0.10>>
	<</if>>
<<elseif $chosenTactic == "Pincer Manouver">>
	<<if $attackType == "raiders">>
		<<set _tacChance += 0.15>>
	<<elseif $attackType == "free city">>
		<<set _tacChance += 0.10>>
	<<elseif $attackType == "old world">>
		<<set _tacChance -= 0.10>>
	<<elseif $attackType == "freedom fighters">>
		<<set _tacChance += 0.15>>
	<</if>>
<<elseif $chosenTactic == "Defense In Depth">>
	<<if $attackType == "raiders">>
		<<set _tacChance -= 0.20>>
	<<elseif $attackType == "free city">>
		<<set _tacChance += 0.10>>
	<<elseif $attackType == "old world">>
		<<set _tacChance += 0.20>>
	<<elseif $attackType == "freedom fighters">>
		<<set _tacChance -= 0.05>>
	<</if>>
<<elseif $chosenTactic == "Blitzkrieg">>
	<<if $attackType == "raiders">>
		<<set _tacChance += 0.10>>
	<<elseif $attackType == "free city">>
		<<set _tacChance -= 0.20>>
	<<elseif $attackType == "old world">>
		<<set _tacChance += 0.25>>
	<<elseif $attackType == "freedom fighters">>
		<<set _tacChance -= 0.10>>
	<</if>>
<<elseif $chosenTactic == "Human Wave">>
	<<if $attackType == "raiders">>
		<<set _tacChance -= 0.10>>
	<<elseif $attackType == "free city">>
		<<set _tacChance += 0.10>>
	<<elseif $attackType == "old world">>
		<<set _tacChance -= 0.15>>
	<<elseif $attackType == "freedom fighters">>
		<<set _tacChance += 0.10>>
	<</if>>
<</if>>

/* Calculates if tactics are successful */
<<if random(1,100) <= _tacChance * 100>>
	<<set _enemyMod -= 0.30>>
	<<set _militiaMod += 0.20>>
	<<set _slaveMod += 0.20>>
	<<set _mercMod += 0.20>>
	<<set _atkMod += 0.10>>
	<<set _defMod += 0.10>>
	<<set $tacticsSuccessful = 1>>
<<else>>
	<<set _enemyMod += 0.20>>
	<<set _militiaMod -= 0.20>>
	<<set _slaveMod -= 0.20>>
	<<set _mercMod -= 0.20>>
	<<set _atkMod -= 0.10>>
	<<set _defMod -= 0.10>>
	<<set $tacticsSuccessful = 0>>
<</if>>

/* enemy morale mods */
<<if $week < 30>>
	<<set _enemyMod += 0.15>>
<<elseif $week < 60>>
	<<set _enemyMod += 0.30>>
<<elseif $week < 90>>
	<<set _enemyMod += 0.45>>
<<elseif $week < 120>>
	<<set _enemyMod += 0.60>>
<<else>>
	<<set _enemyMod += 0.75>>
<</if>>

<<set _secBotsMorale = 0>>
<<set _militiaMorale = 0>>
<<set _slaveMorale = 0>>
<<set _mercMorale = 0>>

/* calculates PC army stats */
<<if $secBots.isDeployed == 1>>
	<<set _attack += ($secBotsBaseAttack + $secBotsBaseAttack * $secBots.equip * $equipMod) * _atkMod>>
	<<set _defense += ($secBotsBaseDefense + $secBotsBaseDefense * $secBots.equip * $equipMod) * _defMod>>
	<<set _hp += $secBotsBaseHp * $secBots.troops>>
<</if>>
<<for _i = 0; _i < _mL; _i++>>
	<<if $militiaUnits[_i].isDeployed == 1>>
		<<if $militiaUnits[_i].training <= 10>>
			<<set _expBonus = 0>>
		<<elseif $militiaUnits[_i].training <= 33>>
			<<set _expBonus = 0.10>>
		<<elseif $militiaUnits[_i].training <= 66>>
			<<set _expBonus = 0.25>>
		<<else>>
			<<set _expBonus = 0.50>>
		<</if>>
		<<set _attack += ($militiaBaseAttack + $militiaBaseAttack * $militiaUnits[_i].equip * $equipMod + $militiaBaseAttack * _expBonus) * _atkMod>>
		<<set _defense += ($militiaBaseDefense + $militiaBaseDefense * $militiaUnits[_i].equip * $equipMod + $militiaBaseDefense * _expBonus) * _defMod>>
		<<set _hp += ($militiaBaseHp + $militiaBaseHp * $militiaUnits[_i].medics * $equipMod) * $militiaUnits[_i].troops>>
	<</if>>
<</for>>
<<for _i = 0; _i < _sL; _i++>>
	<<if $slaveUnits[_i].isDeployed == 1>>
		<<if $slaveUnits[_i].training <= 33>>
			<<set _expBonus = 0>>
		<<elseif $slaveUnits[_i].training <= 66>>
			<<set _expBonus = 0.25>>
		<<else>>
			<<set _expBonus = 0.50>>
		<</if>>
		<<set _attack += ($slaveBaseAttack + $slaveBaseAttack * $slaveUnits[_i].equip * $equipMod + $slaveBaseAttack * _expBonus) * _atkMod>>
		<<set _defense += ($slaveBaseDefense + $slaveBaseDefense * $slaveUnits[_i].equip * $equipMod + $slaveBaseDefense * _expBonus) * _defMod>>
		<<set _hp += ($slaveBaseHp + $slaveBaseHp * $slaveUnits[_i].medics * 0.25) * $slaveUnits[_i].troops>>
	<</if>>
<</for>>
<<for _i = 0; _i < _meL; _i++>>
	<<if $mercUnits[_i].isDeployed == 1>>
		<<if $mercUnits[_i].training <= 33>>
			<<set _expBonus = 0>>
		<<elseif $mercUnits[_i].training <= 66>>
			<<set _expBonus = 0.25>>
		<<else>>
			<<set _expBonus = 0.50>>
		<</if>>
		<<set _attack += ($mercBaseAttack + $mercBaseAttack * $mercUnits[_i].equip * $equipMod + $mercBaseAttack * _expBonus) * _atkMod>>
		<<set _defense += ($mercBaseDefense + $mercBaseDefense * $mercUnits[_i].equip * $equipMod + $mercBaseDefense * _expBonus) * _defMod>>
		<<set _hp += ($mercBaseHp + $mercBaseHp * $mercUnits[_i].medics * 0.25) * $mercUnits[_i].troops>>
	<</if>>
<</for>>

/* morale and baseHp calculation */
<<set _morale = ($secBotsMorale * $deployingBots + _militiaMorale * _militiaMod * $deployingMilitia + $slaveBaseMorale * _slaveMod * $deployingSlaves + $mercBaseMorale * _mercMod * $deployingMercs) / ($deployingBots + $deployingMilitia +$deployingSlaves + $deployingMercs)>>
<<set _morale = _morale + _morale * $secBarracksUpgrades.luxury * 0.05>>	/* barracks bonus */
<<set _baseHp = ($secBotsBaseHp * $deployingBots + $militiaBaseHp * $deployingMilitia + $slaveBaseHp * $deployingSlaves + $mercBaseHp * $deployingMercs) / ($deployingBots + $deployingMilitia +$deployingSlaves + $deployingMercs)>>
				
/* calculates enemy army stats */
<<if $attackType == "raiders">>
	<<set _enemyAttack = $raBaseAttack + $raBaseAttack * $attackEquip * $equipMod>>
	<<set _enemyDefense = $raBaseDefense + $raBaseDefense * $attackEquip * $equipMod>>
	<<set _enemyMorale = $raBaseMorale* _enemyMod>>
	<<set _enemyHp = $raBaseHp * $attackTroops>>
	<<set _enemyBaseHp = $raBaseHp>>
<<elseif $attackType == "free city">>
	<<set _enemyAttack = $fcBaseAttack + $fcBaseAttack * $attackEquip * $equipMod>>
	<<set _enemyDefense = $fcBaseDefense + $fcBaseDefense * $attackEquip * $equipMod>>
	<<set _enemyMorale = $fcBaseMorale * _enemyMod>>
	<<set _enemyHp = $fcBaseHp * $attackTroops>>
	<<set _enemyBaseHp = $fcBaseHp>>
<<elseif $attackType == "old world">>
	<<set _enemyAttack = $owBaseAttack + $owBaseAttack * $attackEquip * $equipMod>>
	<<set _enemyDefense = $owBaseDefense + $owBaseDefense * $attackEquip * $equipMod>>
	<<set _enemyMorale = $owBaseMorale * _enemyMod>>
	<<set _enemyHp = $owBaseHp * $attackTroops>>
	<<set _enemyBaseHp = $owBaseHp>>
<<elseif $attackType == "freedom fighters">>
	<<set _enemyAttack = $ffBaseAttack + $ffBaseAttack * $attackEquip * $equipMod>>
	<<set _enemyDefense = $ffBaseDefense + $ffBaseDefense * $attackEquip * $equipMod>>
	<<set _enemyMorale = $ffBaseMorale * _enemyMod>>
	<<set _enemyHp = $ffBaseHp * $attackTroops>>
	<<set _enemyBaseHp = $ffBaseHp>>
<</if>>

<<if $showBattleStatistics == 1>>
<br>attack: _attack
<br>defense: _defense
<br>Hp: _hp
<br>morale: _morale
<br>attack modifier: _atkMod
<br>defense modifier: _defMod
<br>average base HP: _baseHp
<br>militia morale modifier: _militiaMod
<br>slaves morale modifier: _slaveMod
<br>mercenaries morale modifier: _mercMod
<br>tactic chance of success: _tacChance
<br>was tactic chosen successful?: <<if $tacticsSuccessful == 1>> yes <<else>> no<</if>>
<br>enemy attack: _enemyAttack
<br>enemy defense: _enemyDefense
<br>enemy morale: _enemyMorale
<br>enemy Hp: _enemyHp
<br>enemy base Hp: _enemyBaseHp
<br>enemy morale modifier: _enemyMod
<</if>>


/* simulates the combat by pitting attk against def */
<<for _i = 0; _i < $maxTurns; _i++>>
	<br><br>
	<<if $showBattleStatistics == 1>> turn: _i<</if>>
	/* player army attacks */
	<<set _damage = _attack - _enemyDefense>>
	<<if _damage <= 0>>
		<<set _damage = random(0,5)>>
	<</if>>
	<br>
	<<if $showBattleStatistics == 1>> player damage: _damage<</if>>
	<<set _enemyHp -= _damage>>
	<br>
	<<if $showBattleStatistics == 1>> remaining enemy Hp: _enemyHp<</if>>
	<<set $enemyLosses +=  _damage / _enemyBaseHp>>
	<<set _enemyMorale -= (_damage + _damage / _enemyBaseHp)>>
	<br>
	<<if $showBattleStatistics == 1>> remaining enemy morale: _enemyMorale<</if>>
	<<if _enemyHp <= 0 || _enemyMorale <= 0>>
		<<set $battleResult = 3>>
		<<set $battleTurns = _i>>
		<<break>>
	<</if>>
	
	/* attacker army attacks */
	<<set _damage = _enemyAttack - _defense>>
	<<if _damage <= 0>>
		<<set _damage = random(0,5)>>
	<</if>>
	<br>
	<<if $showBattleStatistics == 1>> enemy damage: _damage<</if>>
	<<set _hp -= _damage>>
	<br>
	<<if $showBattleStatistics == 1>> remaining hp: _hp<</if>>
	<<set $losses = _damage / _baseHp>>
	<<set _morale -= (_damage + _damage / _baseHp)>>
	<br>
	<<if $showBattleStatistics == 1>> remaining morale: _morale<</if>>
	<<if _hp <= 0 || _morale <= 0>>
		<<set $battleResult = -3>>
		<<set $battleTurns = _i>>
		<<break>>
	<</if>>
<</for>>
<<if $battleResult != 3 && $battleResult != -3>>
	<<if _morale > _enemyMorale>>
		<<set $battleResult = 2>>
	<<elseif _morale < _enemyMorale>>
		<<set $battleResult = -2>>
	<</if>>
<</if>>
<<else>>
	<<if $showBattleStatistics == 1>>bribery/surrender chosen<</if>>
	<<if $cash >= $bribeCost>>						/* if there's enough cash there's a 10% chance bribery fails. If there isn't there's instead a 50% chance it fails */
		<<if random(1,100) <= 10>>
			<<set $battleResult = 0>>
		<</if>>
	<<else>>
		<<if random(1,100) <= 50>>
			<<set $battleResult = 0>>
		<</if>>
	<</if>>
<</if>>												/* closes bribe/surrender check */

<<if $battleResult > 3 || $battleResult < -3>>
	Error: failed to determine battle result
<</if>>

<<if $showBattleStatistics == 1>>
	<br><br>
	<<link "proceed">>
	<<goto "attackReport">>
	<</link>>
<<else>>
	<<goto "attackReport">>
<</if>>