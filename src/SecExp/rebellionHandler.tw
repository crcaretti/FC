:: rebellionHandler [nobr]

<<set $nextButton = " ", $nextLink = "attackReport", $showEncyclopedia = 0>>

<<set _turn = 0>>
<<set _attack = 0>>
<<set _defense = 0>>
<<set _morale = 0>>
<<set _hp = 0>>
<<set _baseHp = 0>>
<<set _enemyAttack = 0>>
<<set _enemyDefense = 0>>
<<set _enemyMorale = 0>>
<<set _enemyHp = 0>>
<<set _enemyBaseHp = 0>>
<<set _woundChance = 5>>								/* leader has a base chance of 5% to get wounded */
<<set _tacChance = 0.5>> 								/* by default tactics have a 50% chance of succeeding */
<<set _atkMod = 1>>
<<set _defMod = 1>>
<<set _militiaMod = 1>>
<<set _slaveMod = 1>>
<<set _mercMod = 1>>
<<set _enemyMod = 1>>
<<set _SFMod = 1>>
<<set _expBonus = 0>>
<<set _armyMod = 0>>

<<if $leadingTroops == "PC">>
	<<if $authority <= 2500 && $authority > 1000>>
		<<set _slaveMod -= 0.10>>
	<<elseif $authority <= 1000>>
		<<set _slaveMod -= 0.25>>
	<<elseif $authority >= 5000 && $authority < 15000>>
		<<set _slaveMod += 0.10>>
	<<elseif $authority >= 15000>>
		<<set _slaveMod += 0.25>>
	<</if>>
	<<if $PC.career == "escort" || $PC.career == "servant">>
		<<set _slaveMod += 0.10>>
	<<elseif $PC.career == "slaver">>
		<<set _slaveMod -= 0.10>>
	<</if>>
	<<if $rep <= 2500 && $rep > 1000>>
		<<set _militiaMod -= 0.10>>
	<<elseif $rep <= 1000>>
		<<set _militiaMod -= 0.25>>
	<<elseif $rep >= 5000 && $rep < 15000>>
		<<set _militiaMod += 0.10>>
	<<elseif $rep >= 15000>>
		<<set _militiaMod += 0.25>>
	<</if>>
	<<if $PC.career == "celebrity" || $PC.career == "capitalist">>
		<<set _militiaMod += 0.10>>
	<<elseif $PC.career == "gang" || $PC.career == "escort">>
		<<set _militiaMod -= 0.10>>
	<</if>>
	<<if $mercLoyalty <= 25>>
		<<set _mercMod -= 0.10>>
	<<elseif $mercLoyalty <= 10>>
		<<set _mercMod -= 0.25>>
	<<elseif $mercLoyalty >= 50 && $mercLoyalty < 75>>
		<<set _mercMod += 0.10>>
	<<elseif $mercLoyalty >= 75>>
		<<set _mercMod += 0.25>>
	<</if>>
	<<if $PC.career == "mercenary">>
		<<set _mercMod += 0.10>>
		<<set _SFMod += 0.10>>
	<<elseif $PC.career == "wealth" || $PC.career == "servant">>
		<<set _mercMod -= 0.10>>
		<<set _SFMod -= 0.10>>
	<</if>>
	<<if $rep >= 15000>>
		<<set _enemyMod -= 0.10>>
	<</if>>
	<<if $PC.warfare <= 25 && $PC.warfare > 10>>
		<<set _atkMod -= 0.15>>
	<<elseif $PC.warfare <= 10>>
		<<set _atkMod -= 0.20>>
		<<set _defMod -= 0.10>>
	<<elseif $PC.warfare >= 50 && $PC.warfare >= 50>>
		<<set _atkMod += 0.15>>
	<<elseif $PC.warfare >= 75>>
		<<set _atkMod += 0.20>>
		<<set _defMod += 0.10>>
	<</if>>
	/* 80% chance of increasing warfare */
	<<if $PC.warfare < 100 && random(1,100) <= 80>>
		<<set $gainedWarfare = 1>>
		<<set $PC.warfare += 10>>
		<<set $PC.warfare = Math.clamp($PC.warfare,-100,100)>>
	<</if>>
		/* does the PC get wounded? */
	<<if $PC.career == "mercenary" || $PC.career == "gang">>
		<<set _woundChance -= 3>>
	<</if>>
	<<if $PC.physicalAge >= 60>>
		<<set _woundChance += 1>>
	<</if>>
	<<if $PC.belly > 5000>>
		<<set _woundChance += 1>>
	<</if>>
	<<if $PC.boobsBonus >= 2>>
		<<set _woundChance += 1>>
	<</if>>
	<<if $PC.butt >= 2>>
		<<set _woundChance += 1>>
	<</if>>
	<<if $PC.preg >= 30>>
		<<set _woundChance += 1>>
	<</if>>
	<<if $PC.balls == 2>>
		<<set _woundChance += 1>>
	<</if>>
	<<if $PC.ballsImplant >= 2>>
		<<set _woundChance += 1>>
	<</if>>	
	<<if random(1,100) <= _woundChance>>
		<<set $leaderWounded = 1>>
		<<set _militiaMod -= 0.2>>
		<<set _slaveMod -= 0.2>>
		<<set _mercMod -= 0.2>>
		<<set _SFMod -= 0.2>>
		<<set _enemyMod += 0.2>>
		<<set $PCWounded = 1>>
	<</if>>
<<elseif $leadingTroops == "assistant">>
	<<if $rep < 10000 && $authority < 10000>>
		<<set _militiaMod -= 0.15>>
		<<set _slaveMod -= 0.15>>
		<<set _mercMod -= 0.15>>
		<<set _SFMod -= 0.15>>
	<</if>>
	<<if $assistantPower == 0>>
		<<set _atkMod -= 0.10>>
		<<set _defMod -= 0.10>>
	<<elseif $assistantPower == 2>>
		<<set _atkMod += 0.15>>
		<<set _defMod += 0.15>>
	<</if>>
<<elseif $leadingTroops == "bodyguard">>
	<<if $Bodyguard.devotion < -20>>
		<<set _slaveMod -= 0.15>>
	<<elseif $Bodyguard.devotion >= 50>>
		<<set _slaveMod += 0.15>>
	<</if>>
	<<if ($rep < 10000 && $authority < 10000) || $Bodyguard.prestige < 1>>
		<<set _militiaMod -= 0.15>>
		<<set _mercMod -= 0.15>>
		<<set _SFMod -= 0.15>>
	<<elseif $Bodyguard.prestige >= 2>>
		<<set _militiaMod += 0.10>>
		<<set _mercMod += 0.10>>
		<<set _SFMod += 0.10>>
	<</if>>
	<<if (setup.bodyguardCareers.includes($Bodyguard.career) || setup.HGCareers.includes($Bodyguard.career)) && $Bodyguard.intelligence == 3>>
		<<set _atkMod += 0.25>>
		<<set _defMod += 0.25>>
	<<elseif $Bodyguard.intelligence == 3>>
		<<set _atkMod += 0.20>>
		<<set _defMod += 0.15>>
	<<elseif (setup.bodyguardCareers.includes($Bodyguard.career) || setup.HGCareers.includes($Bodyguard.career)) && $Bodyguard.intelligence == 2>>
		<<set _atkMod += 0.15>>
		<<set _defMod += 0.10>>
	<<elseif $Bodyguard.intelligence == 2>>
		<<set _atkMod += 0.10>>
		<<set _defMod += 0.10>>
	<<elseif setup.bodyguardCareers.includes($Bodyguard.career) || setup.HGCareers.includes($Bodyguard.career) && $Bodyguard.intelligence >= 1>>
		<<set _atkMod += 0.10>>
		<<set _defMod += 0.05>>
	<<elseif !(setup.bodyguardCareers.includes($Bodyguard.career) && setup.HGCareers.includes($Bodyguard.career)) || $Bodyguard.intelligence <= -2>>
		<<set _atkMod -= 0.15>>
		<<set _defMod -= 0.15>>
	<<elseif $Bodyguard.intelligence <= -2>>
		<<set _atkMod -= 0.15>>
		<<set _defMod -= 0.10>>
	<<elseif !(setup.bodyguardCareers.includes($Bodyguard.career) && setup.HGCareers.includes($Bodyguard.career)) || $Bodyguard.intelligence <= -1>>
		<<set _atkMod -= 0.10>>
		<<set _defMod -= 0.10>>
	<<elseif $Bodyguard.intelligence <= -1>>
		<<set _atkMod -= 0.10>>
		<<set _defMod -= 0.05>>
	<</if>>
		/* does she get wounded? */
	<<if $Bodyguard.combatSkill == 1>>
		<<set _woundChance -= 2>>
	<</if>>
	<<if $Bodyguard.amp >= -4>>
		<<set _woundChance -= 1>>
	<</if>>
	<<if $Bodyguard.health >= 50>>
		<<set _woundChance -= 1>>
	<</if>>
	<<if $Bodyguard.weight > 130>>
		<<set _woundChance += 1>>
	<</if>>
	<<if $Bodyguard.muscles < -30>>
		<<set _woundChance += 1>>
	<</if>>
	<<if $Bodyguard.eyes <= -2>>
		<<set _woundChance += 1>>
	<</if>>
	<<if $Bodyguard.heels == 1>>
		<<set _woundChance += 1>>
	<</if>>
	<<if $Bodyguard.boobs >= 1400>>
		<<set _woundChance += 1>>
	<</if>>
	<<if $Bodyguard.butt >= 6>>
		<<set _woundChance += 1>>
	<</if>>
	<<if $Bodyguard.preg >= 30>>
		<<set _woundChance += 1>>
	<</if>>
	<<if $Bodyguard.dick >= 8>>
		<<set _woundChance += 1>>
	<</if>>
	<<if $Bodyguard.balls >= 8>>
		<<set _woundChance += 1>>
	<</if>>
	<<if $Bodyguard.intelligence <= -3>>
		<<set _woundChance += 1>>
	<</if>>	
	<<if random(1,100) <= _woundChance>>
		<<set $leaderWounded = 1>>
		<<set _militiaMod -= 0.2>>
		<<set _slaveMod -= 0.2>>
		<<set _mercMod -= 0.2>>
		<<set _SFMod -= 0.2>>
		<<set _enemyMod += 0.2>>
		<<set $woundType = random(1,10)>>
		<<if $woundType == 1>>
			<<set $Bodyguard.voice = 0>>
		<<elseif $woundType == 2>>
			<<set $Bodyguard.eyes = -2>>
		<<elseif $woundType == 3>>
			<<set $Bodyguard.amp = 1>>
		<<elseif $woundType >= 4>>
			<<if $Bodyguard.health >= -60>>
				<<set $Bodyguard.health -= 30>>
			<<else>>
				<<set $Bodyguard.health -= Math.abs(90 - $Bodyguard.health)>>
			<</if>>
		<</if>>
	<</if>>
	/* 60% chance of getting combat skill if not already have it */
	<<if $Bodyguard.combatSkill == 0 && random(1,100) <= 60>>
		<<set $gainedCombat = 1>>
		<<set $Bodyguard.combatSkill = 1>>
	<</if>>
<<elseif $leadingTroops == "headGirl">>
	<<if $HeadGirl.devotion < -20>>
		<<set _slaveMod -= 0.15>>
	<<elseif $HeadGirl.devotion > 51>>
		<<set _slaveMod += 0.15>>
	<</if>>
	<<if ($rep < 10000 && $authority < 10000) || $HeadGirl.prestige < 1>>
		<<set _militiaMod -= 0.15>>
		<<set _mercMod -= 0.15>>
		<<set _SFMod -= 0.15>>
	<<elseif $HeadGirl.prestige >= 2>>
		<<set _militiaMod += 0.10>>
		<<set _mercMod += 0.10>>
		<<set _SFMod += 0.10>>
	<</if>>
	<<if (setup.bodyguardCareers.includes($HeadGirl.career) || setup.HGCareers.includes($HeadGirl.career)) && $HeadGirl.intelligence == 3>>
		<<set _atkMod += 0.25>>
		<<set _defMod += 0.25>>
	<<elseif $HeadGirl.intelligence == 3>>
		<<set _atkMod += 0.20>>
		<<set _defMod += 0.15>>
	<<elseif (setup.bodyguardCareers.includes($HeadGirl.career) || setup.HGCareers.includes($HeadGirl.career)) && $HeadGirl.intelligence == 2>>
		<<set _atkMod += 0.15>>
		<<set _defMod += 0.10>>
	<<elseif $HeadGirl.intelligence == 2>>
		<<set _atkMod += 0.10>>
		<<set _defMod += 0.10>>
	<<elseif setup.bodyguardCareers.includes($HeadGirl.career) || setup.HGCareers.includes($HeadGirl.career) && $HeadGirl.intelligence >= 1>>
		<<set _atkMod += 0.10>>
		<<set _defMod += 0.05>>
	<<elseif !(setup.bodyguardCareers.includes($HeadGirl.career) && setup.HGCareers.includes($HeadGirl.career)) || $HeadGirl.intelligence <= -2>>
		<<set _atkMod -= 0.15>>
		<<set _defMod -= 0.15>>
	<<elseif $HeadGirl.intelligence <= -2>>
		<<set _atkMod -= 0.15>>
		<<set _defMod -= 0.10>>
	<<elseif !(setup.bodyguardCareers.includes($HeadGirl.career) && setup.HGCareers.includes($HeadGirl.career)) || $HeadGirl.intelligence <= -1>>
		<<set _atkMod -= 0.10>>
		<<set _defMod -= 0.10>>
	<<elseif $HeadGirl.intelligence <= -1>>
		<<set _atkMod -= 0.10>>
		<<set _defMod -= 0.05>>
	<</if>>
	/* does she get wounded? */
	<<if $HeadGirl.combatSkill == 1>>
		<<set _woundChance -= 3>>
	<</if>>
	<<if $HeadGirl.amp >= -4>>
		<<set _woundChance -= 1>>
	<</if>>
	<<if $HeadGirl.health >= 50>>
		<<set _woundChance -= 2>>
	<</if>>
	<<if $HeadGirl.weight > 130>>
		<<set _woundChance += 1>>
	<</if>>
	<<if $HeadGirl.muscles < -30>>
		<<set _woundChance += 1>>
	<</if>>
	<<if $HeadGirl.eyes <= -2>>
		<<set _woundChance += 1>>
	<</if>>
	<<if $HeadGirl.heels == 1>>
		<<set _woundChance += 1>>
	<</if>>
	<<if $HeadGirl.boobs >= 1400>>
		<<set _woundChance += 1>>
	<</if>>
	<<if $HeadGirl.butt >= 6>>
		<<set _woundChance += 1>>
	<</if>>
	<<if $HeadGirl.preg >= 30>>
		<<set _woundChance += 1>>
	<</if>>
	<<if $HeadGirl.dick >= 8>>
		<<set _woundChance += 1>>
	<</if>>
	<<if $HeadGirl.balls >= 8>>
		<<set _woundChance += 1>>
	<</if>>
	<<if $HeadGirl.intelligence <= -3>>
		<<set _woundChance += 1>>
	<</if>>	
	<<if random(1,100) <= _woundChance>>
		<<set $leaderWounded = 1>>
		<<set _militiaMod -= 0.2>>
		<<set _slaveMod -= 0.2>>
		<<set _mercMod -= 0.2>>
		<<set _SFMod -= 0.2>>
		<<set _enemyMod += 0.2>>
		<<set $woundType = random(1,10)>>
		<<if $woundType == 1>>
			<<set $HeadGirl.voice = 0>>
		<<elseif $woundType == 2>>
			<<set $HeadGirl.eyes = -2>>
		<<elseif $woundType == 3>>
			<<set $HeadGirl.amp = 1>>
		<<elseif $woundType >= 4>>
			<<set $HeadGirl.health -= 40>>
		<</if>>
	<</if>>
	/* 60% chance of getting combat skill if nto already have it */
	<<if $HeadGirl.combatSkill == 0 && random(1,100) <= 60>>
		<<set $gainedCombat = 1>>
		<<set $HeadGirl.combatSkill = 1>>
	<</if>>
<<elseif $leadingTroops == "citizen">>
	<<if $arcologies[0].FSDegradationist == "unset" && $arcologies[0].FSPaternalist == "unset">>
		<<set _militiaMod += 0.15>>
		<<set _slaveMod -= 0.15>>
	<<elseif $arcologies[0].FSPaternalist != "unset">>
		<<set _militiaMod += 0.15>>
		<<set _slaveMod += 0.10>>
	<<elseif $arcologies[0].FSDegradationist != "unset">>
		<<set _militiaMod += 0.15>>
		<<set _slaveMod -= 0.35>>
	<</if>>
	<<if $arcologies[0].FSRomanRevivalist != "unset">>
		<<set _mercMod += 0.10>>
		<<set _SFMod += 0.10>>
	<<else>>
		<<set _mercMod -= 0.10>>
		<<set _SFMod -= 0.10>>
	<</if>>
	<<set _atkMod += either(-1,1) * random(10) * 0.1>>
	<<set _defMod += either(-1,1) * random(10) * 0.1>>
<<elseif $leadingTroops == "mercenary">>
	<<set _mercMod += 0.10>>
	<<set _SFMod += 0.10>>
	<<if $arcologies[0].FSRomanRevivalist != "unset">>
		<<set _militiaMod += 0.10>>
	<<else>>
		<<set _militiaMod -= 0.10>>
	<</if>>
	<<if $arcologies[0].FSDegradationist != "unset">>
		<<set _slaveMod -= 0.35>>
	<</if>>
	<<set _atkMod += random(15) * 0.1>>
	<<set _defMod += random(15) * 0.1>>
<<elseif $leadingTroops == "colonel">>
	<<set _mercMod += 0.10>>
	<<set _SFMod += 0.15>>
	<<if $arcologies[0].FSRomanRevivalist != "unset">>
		<<set _militiaMod += 0.10>>
	<<else>>
		<<set _militiaMod -= 0.10>>
	<</if>>
	<<if $arcologies[0].FSDegradationist != "unset">>
		<<set _slaveMod -= 0.35>>
	<</if>>
	<<set _atkMod += random(30) * 0.1>>
	<<set _defMod += random(30) * 0.1>>
<</if>>

/* calculates PC army stats */
<<if 

<<if $secBots.active == 1>>
	<<set _attack += ($secBotsBaseAttack + $secBotsBaseAttack * $secBots.equip * $equipMod) * _atkMod>>
	<<set _defense += ($secBotsBaseDefense + $secBotsBaseDefense * $secBots.equip * $equipMod) * _defMod>>
	<<set _hp += $secBotsBaseHp * $secBots.troops>>
<</if>>
<<for _i = 0; _i < $militiaUnits.length; _i++>>
	<<if $militiaUnits[_i].active == 1 && !($rebellingUnits.contains($militiaUnits[_i]))>>
		<<if $militiaUnits[_i].training <= 10>>
			<<set _expBonus = 0>>
		<<elseif $militiaUnits[_i].training <= 33>>
			<<set _expBonus = 0.10>>
		<<elseif $militiaUnits[_i].training <= 66>>
			<<set _expBonus = 0.25>>
		<<else>>
			<<set _expBonus = 0.50>>
		<</if>>
		<<set _attack += ($militiaBaseAttack + $militiaBaseAttack * $militiaUnits[_i].equip * $equipMod + $militiaBaseAttack * _expBonus + $militiaUnits[_i].SF) * _atkMod>>
		<<set _defense += ($militiaBaseDefense + $militiaBaseDefense * $militiaUnits[_i].equip * $equipMod + $militiaBaseDefense * _expBonus + $militiaUnits[_i].SF) * _defMod>>
		<<set _hp += ($militiaBaseHp + $militiaBaseHp * $militiaUnits[_i].medics * $equipMod) * $militiaUnits[_i].troops>>
	<</if>>
<</for>>
<<for _i = 0; _i < $slaveUnits.length; _i++>>
	<<if $slaveUnits[_i].active == 1 && !($rebellingUnits.contains($slaveUnits[_i]))>>
		<<if $slaveUnits[_i].training <= 33>>
			<<set _expBonus = 0>>
		<<elseif $slaveUnits[_i].training <= 66>>
			<<set _expBonus = 0.25>>
		<<else>>
			<<set _expBonus = 0.50>>
		<</if>>
		<<set _attack += ($slaveBaseAttack + $slaveBaseAttack * $slaveUnits[_i].equip * $equipMod + $slaveBaseAttack * _expBonus + $slaveUnits[_i].SF) * _atkMod>>
		<<set _defense += ($slaveBaseDefense + $slaveBaseDefense * $slaveUnits[_i].equip * $equipMod + $slaveBaseDefense * _expBonus + $slaveUnits[_i].SF) * _defMod>>
		<<set _hp += ($slaveBaseHp + $slaveBaseHp * $slaveUnits[_i].medics * 0.25) * $slaveUnits[_i].troops>>
	<</if>>
<</for>>
<<for _i = 0; _i < $mercUnits.length; _i++>>
	<<if $mercUnits[_i].active == 1 && !($rebellingUnits.contains($mercUnits[_i]))>>
		<<if $mercUnits[_i].training <= 33>>
			<<set _expBonus = 0>>
		<<elseif $mercUnits[_i].training <= 66>>
			<<set _expBonus = 0.25>>
		<<else>>
			<<set _expBonus = 0.50>>
		<</if>>
		<<set _attack += ($mercBaseAttack + $mercBaseAttack * $mercUnits[_i].equip * $equipMod + $mercBaseAttack * _expBonus + $mercUnits[_i].SF) * _atkMod>>
		<<set _defense += ($mercBaseDefense + $mercBaseDefense * $mercUnits[_i].equip * $equipMod + $mercBaseDefense * _expBonus + $mercUnits[_i].SF) * _defMod>>
		<<set _hp += ($mercBaseHp + $mercBaseHp * $mercUnits[_i].medics * 0.25) * $mercUnits[_i].troops>>
	<</if>>
<</for>>

<<if $SFIntervention == 1>>
	<<set _SFatk = 0>>
	<<set _SFdef = 0>>
	<<set _SFhp = 0>>
	<<calcSFStatistics>>
	<<set _attack += _SFatk>>
	<<set _defense += _SFdef>>
	<<set _hp += _SFhp>>
<</if>>

/* morale and baseHp calculation */
/* minimum modifier is -50%, maximum is +50% */
<<if _militiaMod < 0.5>>
	<<set _militiaMod = 0.5>>
<<elseif _militiaMod > 1.5>>
	<<set _militiaMod = 1.5>>
<</if>>
<<if _slaveMod < 0.5>>
	<<set _slaveMod = 0.5>>
<<elseif _slaveMod > 1.5>>
	<<set _slaveMod = 1.5>>
<</if>>
<<if _mercMod < 0.5>>
	<<set _mercMod = 0.5>>
<<elseif _mercMod > 1.5>>
	<<set _mercMod = 1.5>>
<</if>>
<<if _SFMod < 0.5>>
	<<set _SFMod = 0.5>>
<<<elseif _SFMod > 1.5>>
	<<set _SFMod = 1.5>>
<</if>>
<<set _morale = ($secBotsMorale * $deployingBots + $militiaBaseMorale * _militiaMod * $deployingMilitia + $slaveBaseMorale * _slaveMod * $deployingSlaves + $mercBaseMorale * _mercMod * $deployingMercs + $SFBaseMorale * $SFIntervention * _SFMod) / ($deployingBots + $deployingMilitia +$deployingSlaves + $deployingMercs + $SFIntervention)>>
<<set _morale = _morale + _morale * $secBarracksUpgrades.luxury * 0.05>>	/* barracks bonus */
<<set _baseHp = ($secBotsBaseHp * $deployingBots + $militiaBaseHp * $deployingMilitia + $slaveBaseHp * $deployingSlaves + $mercBaseHp * $deployingMercs + $SFBaseHp * $SFIntervention) / ($deployingBots + $deployingMilitia +$deployingSlaves + $deployingMercs + $SFIntervention)>>
				